name: Build & Release OpenList Frontend

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Frontend version (e.g. 4.1.9)"
        required: true
        type: string

jobs:
  build-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write   # 必须，否则不能创建 release

    steps:
      # ======================
      # Checkout
      # ======================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ======================
      # Node & pnpm
      # ======================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      # ======================
      # Install deps
      # ======================
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ======================
      # Set frontend version
      # ======================
      - name: Set frontend version
        run: |
          jq --arg version "${{ inputs.version }}" \
            '.version = $version' package.json > package.json.tmp
          mv package.json.tmp package.json

      # ======================
      # Build standard
      # ======================
      - name: Build standard frontend
        run: pnpm build

      - name: Package standard dist
        run: |
          VERSION="${{ inputs.version }}"
          TAR="openlist-frontend-dist-v${VERSION}.tar.gz"

          test -f dist/index.html

          rm -f "$TAR"
          tar -czf "$TAR" dist

          mkdir -p release
          mv "$TAR" release/

      # ======================
      # Build lite
      # ======================
      - name: Build lite frontend
        run: pnpm build:lite

      - name: Package lite dist
        run: |
          VERSION="${{ inputs.version }}"
          TAR="openlist-frontend-dist-lite-v${VERSION}.tar.gz"

          test -f dist/index.html

          rm -f "$TAR"
          tar -czf "$TAR" dist

          mkdir -p lite-release
          mv "$TAR" lite-release/

      # ======================
      # Verify structure
      # ======================
      - name: Verify tar structure
        run: |
          echo "=== standard ==="
          tar -tzf release/openlist-frontend-dist-v${{ inputs.version }}.tar.gz | head -20
          echo "=== lite ==="
          tar -tzf lite-release/openlist-frontend-dist-lite-v${{ inputs.version }}.tar.gz | head -20

      # ======================
      # Create GitHub Release
      # ======================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: v${{ inputs.version }}
          body: |
            Custom OpenList Frontend v${{ inputs.version }}

            - Standard frontend
            - Lite frontend

            Compatible with OpenList backend build.sh
          files: |
            release/openlist-frontend-dist-v${{ inputs.version }}.tar.gz
            lite-release/openlist-frontend-dist-lite-v${{ inputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
